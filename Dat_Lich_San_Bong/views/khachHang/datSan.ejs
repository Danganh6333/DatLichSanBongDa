<div class="header">
    <button class="header-btn">Đổi Lịch Nhanh</button>
    <select class="header-dropdown">
        <% sanBongs.forEach(sanBong=> { %>
            <option value="<%= sanBong._id %>">
                <%= sanBong.tenSan %>
            </option>
            <% }) %>
    </select>
    <button class="header-btn" onclick="openAppointment()">Điền Thông Tin</button>
</div>
<div class="appointments">
    <section class="notes">
        <h2>Chú Giải Trạng Thái</h2>
        <div class="status-item">
            <p>Sau thời gian cho phép đặt</p>
        </div>
        <div class="status-item">
            <p>Trạng thái mới đặt</p>
        </div>
        <div class="status-item">
            <p>Sân đã được đặt hết</p>
        </div>
        <h2>Sau Khi Thanh Toán</h2>
        <div class="status-item">
            <p>Trạng thái đang đá</p>
        </div>
        <div class="status-item">
            <p>Trạng thái Chờ nhận sân</p>
        </div>
        <div class="status-item">
            <p>Trạng thái Chờ thanh toán</p>
        </div>
        <div class="status-item">
            <p>Trạng thái Đặt nhưng không đá</p>
        </div>
    </section>
    <section class="calendars">
        <div id="calendar"></div>
    </section>
    <section class="event">
        <h2>Sự Kiện</h2>
        <table>
            <thead>
                <tr>
                    <th>Thông tin ca</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Thông tin ca 1</td>
                    <td><button class="action-btn">Xem</button></td>
                </tr>
                <tr>
                    <td>Thông tin ca 2</td>
                    <td><button class="action-btn">Xoá</button></td>
                </tr>
            </tbody>
        </table>
    </section>
</div>
<div class="form-popup" id="myForm">
    <form action="" class="form-container">
        <h2 class="form-title">
            Lựa Chọn Ca
            <span class="close-icon" onclick="closeForm()">&#215;</span>
        </h2>
        <div class="caLamViec-grid">
            <% caLamViecs.forEach(element=> { %>
                <button type="button" class="caLamViec-item"
                    onclick="selectCa('<%= element._id %>', '<%= element.tenCa %>', '<%= element.gioBatDau %>', '<%= element.gioKetThuc %>', '<%= element.tongTien %>', event)">
                    <p><strong>
                            <%= element.tenCa %>
                        </strong>: <%= element.gioBatDau %> - <%= element.gioKetThuc %>
                    </p>
                    <p>Giá Tiền: <%= element.tongTien %>
                    </p>
                </button>
                <% }) %>
        </div>
        <div class="date-select">
            <label for="dateType">Chọn loại ngày:</label>
            <select id="dateType" onchange="updateDatePickerMode()">
                <option value="single">Chọn Một Ngày</option>
                <option value="multiple">Chọn Nhiều Ngày</option>
            </select>

            <label for="datePicker">Chọn Ngày:</label>
            <input type="text" id="datePicker" placeholder="Chọn ngày" />
        </div>
        <div class="button-group">
            <button type="button" class="btn save" onclick="saveEvent()">Lưu Ca</button>
        </div>
    </form>
</div>
<div class="form-popup" id="addAppointment">
    <form action="" class="form-container">
        <h2 class="form-title">Đặt Sân</h2>
        <table>
            <tr>
                <th>Ca</th>
                <th>Ngày</th>
                <th>Giá Sân</th>
                <th>Thao tác</th>
            </tr>
            <tr>
                <td>
                    <select class="header-dropdown">
                        <% sanBongs.forEach(sanBong=> { %>
                            <option value="<%= sanBong._id %>">
                                <%= sanBong.tenSan %>
                            </option>
                            <% }) %>
                    </select>
                </td>
                <td>
                    <input type="date" value="2017-06-01" />
                </td>
                <td>
                    <input type="number" name="" id="" placeholder="Nhập giá">
                </td>
                <td class="button-group">
                    <button>Thêm Ca</button>
                </td>
            </tr>
        </table>
        <p></p>
        <button type="button" class="btn cancel" onclick="closeAppointment()">Close</button>
    </form>
</div>
<script type="text/javascript">

    let selectedDates = [];
    let selectedCa = null;
    let calendar;
    let datePicker;

    function selectCa(id, tenCa, gioBatDau, gioKetThuc, tongTien, event) {
        selectedCa = { _id: id, tenCa, gioBatDau, gioKetThuc, tongTien };
        document.querySelectorAll('.caLamViec-item').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
    }

    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            selectable: true,
            dateClick: function (info) {
                const selected = new Date(info.dateStr);
                const today = new Date();

                // Console log the selected date
                console.log(selected, "Selected Date");

                today.setHours(0, 0, 0, 0);
                selected.setHours(0, 0, 0, 0);

                if (selected <= today) {
                    alert('Ngày đã qua hoặc là ngày hiện tại, bạn không thể chọn.');
                    return;
                }

                selectedDates = [info.dateStr];
                datePicker.setDate(info.dateStr, true); // Set date in flatpickr
                openForm();
            },
        });
        calendar.render();

        datePicker = flatpickr("#datePicker", {
            dateFormat: "Y-m-d",
            mode: "single",
            minDate: new Date().fp_incr(1),
            onChange: function (dates) {
                selectedDates = dates.map(date => date.toISOString().split('T')[0]);
            }
        });
    });

    function updateDatePickerMode() {
        const dateType = document.getElementById("dateType").value;
        datePicker.set("mode", dateType === "multiple" ? "multiple" : "single");
        selectedDates = [];
    }

    function saveEvent() {
        if (!selectedCa) {
            alert("Vui lòng chọn một ca làm việc trước.");
            return;
        }
        if (selectedDates.length === 0) {
            alert("Vui lòng chọn ít nhất một ngày.");
            return;
        }

        console.log(selectedDates);

        selectedDates.forEach(date => {
        
            const startDate = new Date(`${date}T${selectedCa.gioBatDau}:00`);
            const endDate = new Date(`${date}T${selectedCa.gioKetThuc}:00`);

            startDate.setMinutes(startDate.getMinutes() - startDate.getTimezoneOffset() + 7 * 60);
            endDate.setMinutes(endDate.getMinutes() - endDate.getTimezoneOffset() + 7 * 60);

            console.log(startDate, "Start");
            console.log(endDate, "End");

            calendar.addEvent({
                title: selectedCa.tenCa,
                start: startDate,
                end: endDate,
                description: `${selectedCa.tongTien} VND`,
                allDay: false
            });
        });

        closeForm();
    }

    function openForm() {
        document.getElementById("myForm").style.display = "block";
    }

    function closeForm() {
        document.getElementById("myForm").style.display = "none";
    }

    function openAppointment() {
        closeAllPopups();
        document.getElementById("addAppointment").style.display = "block";
    }

    function closeAppointment() {
        document.getElementById("addAppointment").style.display = "none";
    }


</script>